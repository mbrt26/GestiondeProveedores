<!-- Top Navbar -->
<nav class="top-navbar d-flex align-items-center justify-content-between">
    <!-- Left side -->
    <div class="d-flex align-items-center">
        <!-- Mobile toggle -->
        <button class="btn btn-link d-lg-none text-dark me-2" id="sidebarToggle">
            <i class="bi bi-list fs-4"></i>
        </button>

        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                {% block breadcrumb %}
                <li class="breadcrumb-item active">Dashboard</li>
                {% endblock %}
            </ol>
        </nav>
    </div>

    <!-- Right side -->
    <div class="d-flex align-items-center">
        <!-- Search -->
        <div class="input-group me-3 d-none d-md-flex" style="width: 250px;">
            <span class="input-group-text bg-light border-0">
                <i class="bi bi-search text-muted"></i>
            </span>
            <input type="text" class="form-control bg-light border-0" placeholder="Buscar...">
        </div>

        <!-- Notifications -->
        <div class="dropdown me-3">
            <button class="btn btn-link text-dark position-relative" data-bs-toggle="dropdown">
                <i class="bi bi-bell fs-5"></i>
                <span class="notification-badge" id="notificationCount" style="display: none;">0</span>
            </button>
            <div class="dropdown-menu dropdown-menu-end" style="width: 320px;">
                <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                    <h6 class="mb-0">Notificaciones</h6>
                    <a href="#" class="text-primary text-decoration-none small" id="markAllRead">Marcar como leídas</a>
                </div>
                <div id="notificationList" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-bell-slash fs-1"></i>
                        <p class="mb-0 mt-2">Sin notificaciones</p>
                    </div>
                </div>
                <div class="p-2 border-top">
                    <a href="{% url 'notificaciones:lista' %}" class="btn btn-sm btn-outline-primary w-100">Ver todas</a>
                </div>
            </div>
        </div>

        <!-- User Dropdown -->
        <div class="dropdown">
            <button class="btn btn-link text-dark d-flex align-items-center" data-bs-toggle="dropdown">
                {% if user.foto %}
                <img src="{{ user.foto.url }}" alt="{{ user.get_full_name }}" class="avatar me-2">
                {% else %}
                <div class="avatar bg-primary d-flex align-items-center justify-content-center me-2">
                    <span class="text-white fw-bold small">{{ user.nombre|slice:":1" }}{{ user.apellido|slice:":1" }}</span>
                </div>
                {% endif %}
                <span class="d-none d-md-inline me-1">{{ user.nombre }}</span>
                <i class="bi bi-chevron-down small"></i>
            </button>
            <div class="dropdown-menu dropdown-menu-end">
                <div class="px-3 py-2 border-bottom">
                    <div class="fw-medium">{{ user.get_full_name }}</div>
                    <small class="text-muted">{{ user.email }}</small>
                </div>
                <a class="dropdown-item" href="{% url 'core:perfil' %}">
                    <i class="bi bi-person me-2"></i>Mi Perfil
                </a>
                <a class="dropdown-item" href="{% url 'notificaciones:configuracion' %}">
                    <i class="bi bi-bell me-2"></i>Notificaciones
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item text-danger" href="{% url 'core:logout' %}">
                    <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                </a>
            </div>
        </div>
    </div>
</nav>

<script>
// Fetch notifications on load
document.addEventListener('DOMContentLoaded', function() {
    fetchNotifications();
    // Refresh every 5 minutes
    setInterval(fetchNotifications, 300000);
});

function fetchNotifications() {
    fetch('{% url "notificaciones:no_leidas" %}')
        .then(response => response.json())
        .then(data => {
            const countBadge = document.getElementById('notificationCount');
            const notificationList = document.getElementById('notificationList');

            if (data.count > 0) {
                countBadge.textContent = data.count > 9 ? '9+' : data.count;
                countBadge.style.display = 'flex';

                let html = '';
                data.notificaciones.forEach(notif => {
                    html += `
                        <a href="${notif.enlace || '#'}" class="dropdown-item notification-item py-2" data-id="${notif.id}">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <div class="fw-medium">${notif.titulo}</div>
                                    <small class="text-muted text-truncate d-block">${notif.mensaje}</small>
                                </div>
                            </div>
                        </a>
                    `;
                });
                notificationList.innerHTML = html;
            } else {
                countBadge.style.display = 'none';
                notificationList.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-bell-slash fs-1"></i>
                        <p class="mb-0 mt-2">Sin notificaciones</p>
                    </div>
                `;
            }
        })
        .catch(error => console.error('Error fetching notifications:', error));
}

// Mark all as read
document.getElementById('markAllRead').addEventListener('click', function(e) {
    e.preventDefault();
    fetch('{% url "notificaciones:marcar_todas_leidas" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fetchNotifications();
        }
    });
});
</script>
